{% extends 'layouts/basefile/base.html' %}
{% block content %}
<!-- Start content -->
<div class="content">
    <div class="container-fluid">
        <div class="page-title-box">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <h4 class="page-title">Affiliate</h4>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0);"><i
                                class="mdi mdi-home-outline"></i></a></li>
                        <li class="breadcrumb-item active">Affiliate Dashboard</li>
                    </ol>
                </div>
            </div> <!-- end row -->

        </div>
        <div class="row">
            <div class="col-md-4 col-lg-3">
                <div class="card text-center">
                    <div class="card-body shadow-sm">
                        <img class="rounded-circle" src={{image}}
                             alt="image" width="70%">
                        <h4 class="card-title">Social Links</h4>

                        <a href="#" id="shr_fb" target="_blank" class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="top" title=""
                           data-original-title="facebook"><i class="mdi mdi-facebook noti-icon"></i></a>
                        <a href="https://twitter.com/intent/tweet?text=http%3A%2F%2F192.168.100.33%3A8000%2Faffiliate%3Fur%3D3%26deal%3Dusr3%26sid%3Dsd3" id="shr_twt" target="_blank" class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="top" title=""
                           data-original-title="twitter"><i class="mdi mdi-twitter noti-icon"></i></a>
                        <a href="{% url 'update_profile' %}" class="btn btn-primary btn-sm " data-toggle="tooltip"
                           data-placement="top" title="" data-original-title="Edit"> <i
                                class="mdi mdi-grease-pencil"></i></a>
                        <!-- <a href="{% url 'update_profile' %}" type="button"
                           class="btn btn-sm btn-primary waves-effect p-1 waves-light">Edit
                            Profle</a> -->
                        <div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8 col-lg-9">
                <div class="card mb-2">
                    <div class="shadow-sm">
                        <ul class="nav">
                            <li class="nav-item border-right affiliate_bg_color_tab">
                                <a class="nav-link affiliate_bg_color_tab_avtive" href="#affiliate_dashboard"
                                   data-toggle="tab"
                                   role="tab" aria-selected="true"><i
                                        class="font-16 mdi mdi-view-dashboard"></i> Dashboard</a>
                            </li>
                            <li class="nav-item border-right affiliate_bg_color_tab">
                                <a class="nav-link affiliate_bg_color_tab_avtive " href="#tab2" data-toggle="tab"
                                   role="tab" aria-selected="true"><i
                                        class=" font-16 mdi mdi mdi-feature-search-outline"></i> Details</a>
                            </li>
                            <li class="nav-item border-right affiliate_bg_color_tab">
                                <a class="nav-link affiliate_bg_color_tab_avtive" href="#tab3" data-toggle="tab"
                                   role="tab" aria-selected="true"><i
                                        class=" font-16 mdi mdi mdi-feature-search-outline"></i> Payouts</a>
                            </li>

                        </ul>
                    </div>
                </div>
                <div class="tab-content">
                    <div class="tab-pane pt-3 dashboard active" id="affiliate_dashboard" role="tabpanel">
                        <div class="row">
                            <div class="col-xl-3 col-md-6">
                                <div class="card mb-2 text-center shadow-sm bg-primary text-white">
                                    <div class="p-2">
                                        <h4 class="font-weight-medium font-24">{{clicks}} </h4>
                                        <h5 class="font-16 text-uppercase mt-0 text-white-50">Clicks</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card  mb-2 text-center shadow-sm bg-primary text-white">
                                    <div class="p-2">
                                        <h4 class="font-weight-medium font-24">1,685 </h4>
                                        <h5 class="font-16 text-uppercase mt-0 text-white-50">Customers</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card mb-2 text-center shadow-sm bg-primary text-white">
                                    <div class="p-2">
                                        <h4 class="font-weight-medium font-24">{{sign_ups}} </h4>
                                        <h5 class="font-16 text-uppercase mt-0 text-white-50">Signups</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card  mb-2 text-center shadow-sm bg-primary text-white">
                                    <div class="p-2">
                                        <h4 class="font-weight-medium font-24" id="h_blc">${{balance}}</h4>
                                        <h5 class="font-16 text-uppercase mt-0 text-white-50">Awaiting payouts</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center mb-2">
                            <div class="p-2 bg-info shadow">
                                <h6 class="text-white m-0">You get 20% recurring commission for referring customers to
                                    ProspectX
                                    Subscriptions</h6>
                            </div>
                        </div>
                        <div class="card text-center mb-2">
                            <div class="card-body shadow-sm">
                                <h5 class="text-secondary font-200 mt-0 mb-3 ">Share this referral link to your friends
                                    and
                                    followers <span><a class="text-primary" href="#"
                                                       id="edit_url">Customize link</a></span></h5>
                                <div class="row" id="update_form" style="display: none">
                                    <div class="col-lg-5">
                                        <div>
                                            <div class="form-group mb-4">
                                                <label for="url_name">Url Name</label>
                                                <input id="update_url_name" class="form-control"
                                                       placeholder="" name="url_name"
                                                       value="{{ form.instance.url_name}}">
                                                <div id="name_error" class="text-danger d-none"></div>
                                                <span class="text-muted">Max 5 characters</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-5">
                                        <div class="mt-4 mt-lg-0">
                                            <div class="form-group mb-4">
                                                <label for="sid">Sub Id</label>
                                                <input id="update_sid" class="form-control"
                                                       placeholder="" name="sub_id"
                                                       value="{{ form.instance.sub_id}}">
                                                <div id="sid_error" class="text-danger d-none"></div>
                                                <span class="text-muted">Max 5 characters</span>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="col-lg-2 mt-1">
                                        <button class="btn btn-primary btn-block waves-effect waves-light mt-4"
                                                type="submit" id="update_bt">Update
                                        </button>
                                        <div class="spinner-border text-primary " id="up_loader" style="display: none;"
                                             role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group mb-2 mr-sm-2">
                                    <button class="btn btn-primary waves-effect waves-light"
                                            type="button" id="all_links">
                                        Links
                                    </button>

                                    <input type="text" class="form-control"
                                           id="invite_url" placeholder="{{urls.0.inv_url}}" readonly>
                                    <button class="btn btn-primary" id="bt_copy">Copy</button>
                                </div>
                                <table class="table mb-0" id="url_table" style="display: none;">
                                    <caption>List of Urls</caption>

                                    <tbody id="url_tbody">
                                    {% for url in urls|slice:"1:"%}
                                    <tr>
                                        <td class="inv_url">{{url.inv_url}}</td>
                                        <td><a class="nav-link " id="select_url" href="#"><i
                                                class="font-18 mdi mdi-check text-success"></i></a></td>
                                        <td><a class="nav-link " id="del_url" href="#"><i
                                                class="font-18 mdi mdi-window-close text-danger"></i></a>
                                            <div class="spinner-border text-primary " id="del_loader"
                                                 style="display: none;" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                <div class="modal fade " id="del_modal" tabindex="-1"
                                     role="dialog"
                                     aria-labelledby="mySmallModalLabel" style="display: none;"
                                     aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title mt-0">Delete URL</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">
                                                    ×
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <input hidden id="slct_url">
                                                <input hidden id="cr_row">
                                                <p>Do you really want to delete this URL?</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                                    No
                                                </button>
                                                <button type="submit" id="del_submit" class="btn btn-primary">Yes
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-dark mb-0">Click the "Links" button to view all available links.</p>
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Add Url</h4>
                                    <form class="form" id="add_url_form" action="/affiliate/dashboard" method="post"
                                          onsubmit="submit_url.disabled = true; return true;">
                                        {% csrf_token %}
                                        <input hidden id="url_form" name="url_form" value=True>
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <div>
                                                    <div class="form-group mb-4">
                                                        <label for="url_name">Url Name</label>
                                                        <input id="url_name" class="form-control"
                                                               placeholder="" name="url_name"
                                                               value="{{ form.instance.url_name}}">
                                                        {% if form.url_name.errors %}
                                                        <div class="text-danger">
                                                            {{ form.url_name.errors | striptags }}
                                                        </div>
                                                        {% endif %}
                                                        <span class="text-muted">Max 5 characters</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mt-4 mt-lg-0">
                                                    <div class="form-group mb-4">
                                                        <label for="sid">Sub Id</label>
                                                        <input id="sid" class="form-control"
                                                               placeholder="" name="sub_id"
                                                               value="{{ form.instance.sub_id}}">
                                                        {% if form.sub_id.errors %}
                                                        <div class="text-danger">
                                                            {{ form.sub_id.errors | striptags }}
                                                        </div>
                                                        {% endif %}
                                                        <span class="text-muted">Max 5 characters</span>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary btn-block waves-effect waves-light"
                                                type="submit" name="submit_url" id="submit_url">Add
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane pt-3" id="tab2" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <table class="table mb-0">
                                    <caption>List of urls</caption>
                                    <thead>
                                    <tr>

                                        <th>Url</th>
                                        <th>Clicks</th>
                                        <th>Sign Up</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for url in urls%}
                                    <tr>
                                        <td>{{url.inv_url}}</td>
                                        <td>{{url.click}}</td>
                                        <td>{{url.sign_up}}</td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane pt-3" id="tab3" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <table class="table mb-0">
                                    <caption>PayPal payout</caption>
                                    <thead>
                                    <tr>

                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Min Payout</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>

                                        <td>Paypal</td>
                                        <td>ready</td>
                                        <td>$1</td>
                                        {% if balance != 0 %}
                                        <td><a class="nav-link text-primary" href="#" data-toggle="modal"
                                               data-target="#payout_modal">Payout</a></td>
                                        <div class="modal fade " id="payout_modal" tabindex="-1"
                                             role="dialog"
                                             aria-labelledby="mySmallModalLabel" style="display: none;"
                                             aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title mt-0">PayPal Payout</h5>
                                                        <button type="button" class="close" data-dismiss="modal"
                                                                aria-hidden="true">
                                                            ×
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form class="form" id="paypal_form"
                                                              action="/affiliate/dashboard" method="post">
                                                            {% csrf_token %}
                                                            <input hidden id="payout_form" name="payout_form"
                                                                   value=True>
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <div>
                                                                        <div class="form-group mb-4">
                                                                            <label for="payout_email">PayPal
                                                                                Email</label>
                                                                            <input id="payout_email"
                                                                                   class="form-control"
                                                                                   type="email"
                                                                                   placeholder="" name="payout_email"
                                                                                   value="{{ form.instance.payout_email}}">
                                                                            <div id="email_error"
                                                                                 class="text-danger d-none"></div>
                                                                            <span class="text-muted">e.g "example@email.com"</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <div class="mt-4 mt-lg-0">
                                                                        <div class="form-group mb-4">
                                                                            <label for="amount">Amount</label>
                                                                            <input type="number" step="0.01" id="amount"
                                                                                   class="form-control"
                                                                                   placeholder="" name="amount"
                                                                                   value="{{ form.instance.amount}}">
                                                                            <div id="amount_error"
                                                                                 class="text-danger d-none"></div>
                                                                            <span class="text-muted">"0.00"</span>
                                                                        </div>

                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-12 text-center">
                                                                    <button class="btn btn-primary btn-block waves-effect waves-light"
                                                                            type="submit" id="submit_payout">Payout
                                                                    </button>
                                                                    <div class="spinner-border text-primary "
                                                                         id="p_loader" style="display: none;"
                                                                         role="status">
                                                                        <span class="sr-only">Loading...</span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </form>
                                                        <script></script>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <td class="text-primary"> No Payout</td>
                                        {% endif %}

                                    </tr>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </diV>
</div>
{% endblock %}
{% block extrajs %}
<script>
    $(document).ready(function () {
        var sd = $('input[id="invite_url"]').attr('placeholder');
        var fb_hrf='https://www.facebook.com/sharer/sharer.php?u='+sd;
        $("#shr_fb").attr("href", fb_hrf);
        var cg='Check this out! '+sd;
        var shr_str = encodeURIComponent(cg).replace(/'/g,"%27").replace(/"/g,"%22");
        var twt_hrf='https://twitter.com/intent/tweet?text='+shr_str;
        $("#shr_twt").attr("href", twt_hrf);
    });

    $(document).ready(function () {
        $('#all_links').click(function () {
            $('#url_table').toggle("slide");
        });
    });

    $(document).ready(function () {
        $('button[id="bt_copy"]').click(function () {
            var sd = $('input[id="invite_url"]').attr('placeholder');
            var dummy = $('<input>').val(sd).appendTo('body').select()
            document.execCommand('copy');
            toastr.success('Copied');
        });
    });
    $(document).on('submit', '#paypal_form', function (e) {
        e.preventDefault();
        var amount = $('#amount').val();
        if (amount >= 1) {
            $.ajax({
                type: 'POST',
                url: window.location.origin + "/affiliate/dashboard",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    payout_form: $('#payout_form').val(),
                    payout_email: $('#payout_email').val(),
                    amount: $('#amount').val(),
                },
                beforeSend: function () {
                    $("#submit_payout").hide();
                    $('#p_loader').show();
                },
                complete: function () {
                    $("#submit_payout").show();
                    $('#p_loader').hide();
                },
                success: function (data) {
                    $("#payout_modal").modal('hide');
                    $("#paypal_form").trigger("reset");
                    $("#h_blc").text("$" + data['balance']);
                    toastr.success(data['success']);

                },
                error: function (xhr, ajaxOptions, thrownError) { // on error..
                    // console.log(xhr.status + ": " + xhr.responseText);
                    var err = JSON.parse(xhr.responseText);
                    if (err.hasOwnProperty('form')) {
                        $("#amount_error").removeClass("d-none");
                        $('#amount_error').html(err['form']['amount'][0]);
                        $("#amount_error").addClass("d-block");
                        $("#email_error").removeClass("d-none");
                        $('#email_error').html(err['form']['payout_email'][0]);
                        $("#email_error").addClass("d-block");
                    } else if (err.hasOwnProperty('amount_error')) {
                        $("#amount_error").removeClass("d-none");
                        $('#amount_error').html(err['amount_error']);
                        $("#amount_error").addClass("d-block");
                    } else {
                        $("#payout_modal").modal('hide');
                        toastr.error(err['error']);
                    }

                }
            });
        } else {
            $("#amount_error").removeClass("d-none");
            $('#amount_error').html('Min payout is $1');
            $("#amount_error").addClass("d-block");
        }


    });

    $('#url_table #select_url').click(function () {
        var sd = $('input[id="invite_url"]').attr('placeholder');
        var cr_row = $(this).closest('tr');
        var col1 = cr_row.find('td:eq(0)').text();
        $('#invite_url').attr('placeholder', col1);
        cr_row.find('td:eq(0)').text(sd);
    });
    $('#url_table #del_url').click(function (e) {
        e.preventDefault();
        var cr_row = $(this).closest('tr');
        var col1 = cr_row.find('td:eq(0)').text();
        $("#slct_url").val(col1);
        $("#cr_row").val(cr_row);
        $("#del_modal").modal('show');
    });
    $("#del_submit").click(function () {
        $("#del_modal").modal('hide');
        var col1 = $('#slct_url').val();
        $.ajax({
            type: 'POST',
            url: window.location.origin + "/affiliate/del",
            data: {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                inv_url: col1,
            },
            beforeSend: function () {
                $("#del_url").hide();
                $('#del_loader').show();
            },
            complete: function () {
                $("#del_url").show();
                $('#del_loader').hide();
            },
            success: function (data) {
                $("url_tbody").empty();
                toastr.success('Successfully Deleted');
                location.reload();
            },
            error: function (xhr, ajaxOptions, thrownError) { // on error..
                // console.log(xhr.status + ": " + xhr.responseText);
                var err = JSON.parse(xhr.responseText);
                toastr.error('Error');
            }
        });
    });
    $('#edit_url').click(function (e) {
        e.preventDefault();
        var sd = $('input[id="invite_url"]').attr('placeholder');
        var params = {};
        sd.substring(1).replace(/[?&]+([^=&]+)=([^&]*)/gi,
            function (str, key, value) {
                params[key] = value;
            });
        var name = (params['deal']);
        var sid = (params['sid']);
        $('#update_url_name').val(name);
        $('#update_sid').val(sid);
        $('#update_form').toggle("slide");

    });
    $('#update_bt').click(function (e) {
        e.preventDefault();
        var sd = $('input[id="invite_url"]').attr('placeholder');
        var new_name = $("#update_url_name").val();
        var new_sid = $("#update_sid").val();// get the value of the input field
        if (new_name.trim() !== "" && new_name.length <= 5 && new_sid.trim() !== "" && new_sid.length <= 5) {
            $.ajax({
                type: 'POST',
                url: window.location.origin + "/affiliate/del",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    update: 'true',
                    inv_url: sd,
                    new_name: new_name,
                    new_sid: new_sid
                },
                beforeSend: function () {
                    $("#update_bt").hide();
                    $('#up_loader').show();
                },
                complete: function () {
                    $("#update_bt").show();
                    $('#up_loader').hide();
                },
                success: function (data) {
                    toastr.success('Successfully Update');
                    $("#update_form").hide()
                    location.reload();
                },
                error: function (xhr, ajaxOptions, thrownError) { // on error..
                    // console.log(xhr.status + ": " + xhr.responseText);
                    var err = JSON.parse(xhr.responseText);
                    toastr.error('Error');
                }
            });

            // error = true; // change the error state to true
        } else {
            $("#name_error").removeClass("d-none");
            $('#name_error').html('Enter correct name');
            $("#name_error").addClass("d-block");
            $("#sid_error").removeClass("d-none");
            $('#sid_error').html('Enter correct sub id');
            $("#sid_error").addClass("d-block");
        }
    });

</script>
{% endblock %}